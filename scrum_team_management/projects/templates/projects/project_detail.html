{% extends 'base.html' %}
{% block title %}Project Detail{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Project Header with Edit/Delete Options -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">{{ project.name }}</h3>
                <div>
                    {% if user.is_authenticated and user.role == 'team_leader' %}
                        <a class="btn btn-light btn-sm" href="{% url 'project_update' project.pk %}">Edit</a>
                        <a class="btn btn-danger btn-sm" href="{% url 'project_delete' project.pk %}">Delete</a>
                    {% else %}
                        <button class="btn btn-light btn-sm" disabled>Edit</button>
                        <button class="btn btn-danger btn-sm" disabled>Delete</button>
                    {% endif %}
                </div>
            </div>
            <!-- Main Content Split into Two Columns -->
            <div class="card-body">
                <div class="row">
                    <!-- Left Column: Project Description -->
                    <div class="col-md-6">
                        <p><strong>Description:</strong></p>
                        <p>{{ project.description }}</p>
                    </div>
                    <!-- Right Column: Team & Members -->
                    <div class="col-md-6">
                        <p><strong>Team:</strong></p>
                        {% if project.teams.all %}
                            {% with team=project.teams.first %}
                                <p>{{ team.name }}</p>
                                <ul class="list-group">
                                    {# Team Leader #}
                                    {% for assignment in team.teamassignment_set.all %}
                                        {% if assignment.role == "Team Leader" %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ assignment.user.get_full_name }}
                                                <span class="badge bg-primary">{{ assignment.role }}</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {# Internal PO #}
                                    {% for assignment in team.teamassignment_set.all %}
                                        {% if assignment.role == "Internal PO" %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ assignment.user.get_full_name }}
                                                <span class="badge bg-primary">{{ assignment.role }}</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {# External PO #}
                                    {% for assignment in team.teamassignment_set.all %}
                                        {% if assignment.role == "External PO" %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ assignment.user.get_full_name }}
                                                <span class="badge bg-primary">{{ assignment.role }}</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {# Collaborators #}
                                    {% for assignment in team.teamassignment_set.all %}
                                        {% if assignment.role == "Collaborator" %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ assignment.user.get_full_name }}
                                                <span class="badge bg-secondary">{{ assignment.role }}</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if team.teamassignment_set.count == 0 %}
                                        <li class="list-group-item text-muted">No members assigned.</li>
                                    {% endif %}
                                </ul>
                                {% if user.is_authenticated and user.role == "team_leader" and project.team_set.exists %}
                                    <form method="post" action="{% url 'remove_team_from_project' project.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger w-100">Remove Team from Project</button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <p class="text-muted">No team assigned.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Testers Section -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Testers</h5>
            </div>
            <div class="card-body">
                {% if project.testers.all %}
                    <ul class="list-group mb-3">
                        {% for tester in project.testers.all %}
                            <li class="list-group-item">{{ tester.get_full_name|default:tester.username }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No testers assigned.</p>
                {% endif %}

                {% if user.is_authenticated and user == project.team_leader %}
                    <form method="post" action="{% url 'edit_project_testers' project.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_testers" class="form-label">Edit Testers</label>
                            <select name="testers" id="id_testers" class="form-control" multiple>
                                {% for collaborator in collaborators %}
                                    <option value="{{ collaborator.pk }}"
                                        {% if collaborator in project.testers.all %}selected{% endif %}>
                                        {{ collaborator.get_full_name|default:collaborator.username }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Save Testers</button>
                    </form>
                {% endif %}
            </div>
        </div>
        <!-- Add New Project Update Button -->
        <div class="d-flex justify-content-end mb-3">
            {% if user.is_authenticated and user == project.team_leader %}
                <a href="{% url 'add_project_update' project.pk %}" class="btn btn-primary w-100">Add New Update</a>
            {% else %}
                <button class="btn btn-primary w-100" disabled>Add New Update</button>
            {% endif %}
        </div>
        <!-- Latest Project Update Section -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Latest Project Update</h5>
            </div>
            <div class="card-body">
                {% with latest_update=project.updates.all|dictsortreversed:"created_at"|first %}
                    {% if latest_update %}
                        <p class="mb-1"><strong>Update Entry:</strong> {{ latest_update.created_at|date:"F j, Y, H:i" }}</p>
                        <p class="mb-1"><strong>What was done:</strong><br>{{ latest_update.what_was_done }}</p>
                        <p class="mb-1"><strong>How the project is going:</strong><br>{{ latest_update.how_project_is_going }}</p>
                        <p class="mb-1"><strong>Setbacks:</strong><br>{{ latest_update.setbacks|default:"None" }}</p>
                        <div class="mt-3">
                            <a href="{% url 'project_updates_list' project.pk %}" class="btn btn-outline-primary w-100">View All Updates</a>
                        </div>
                    {% else %}
                        <p class="text-muted">No updates available.</p>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        <!-- Add or Create Team Button -->
        {% if not project.teams.exists %}
        <div class="d-flex justify-content-end mt-3">
            <a href="{% url 'add_team_to_project' project.id %}" class="btn btn-success w-100">Add or Create Team</a>
        </div>
        {% endif %}
        <!-- Remove Team from Project Button -->
        {% if user.is_authenticated and user.role == "team_leader" %}
            <div class="mt-3">
                <form method="post" action="{% url 'remove_team_from_project' project.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100 mt-2">Remove Team from Project</button>
                </form>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}